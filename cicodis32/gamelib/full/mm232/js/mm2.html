<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
</head>
<body>
<style> 
body {  font-family: 'Poppins', sans-serif; user-select: none; background:black;} 
.banner {
  display: flex;
  justify-content: space-between;
  align-items: center;
  padding: 10px 20px;
  background-color: #007BFF;
  color: white;
  font-weight: bold;
  font-size: 1.2rem;
  box-shadow: 0 4px 6px rgba(0, 0, 0, 0.1);
  box-shadow: 0 8px 10px rgba(0, 0, 0, 0.2); 
}
.banner .left-text {
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}
.banner .right-text {
  text-shadow: 1px 1px 2px rgba(0, 0, 0, 0.3);
}
.banner .right-text a {
  color: white;
}
</style>

<link href="https://fonts.googleapis.com/css2?family=Poppins:wght@400;700&display=swap" rel="stylesheet">
<div class="banner">
<div class="left-text">MicroMachines 2 <font color="silver">(cicodis32 javascript port)</font></div>
<div class="right-text"><span id="status">&nbsp;</span>&nbsp;&nbsp;&nbsp;
<select id="level">
  <option value="-1">Select map...</option>
  <option value="16">TRAINING CAMP</option>
  <option value="48">DRILLER KILLER</option>
  <option value="25">SAND CASTLES</option>
  <option value="41">PINBALL PURSUIT</option>
  <option value="8">COB CHALLENGE</option>
  <option value="37">CEILING CIRCUITS</option>
  <option value="30">GARAGE GAMES</option>
  <option value="11">ATV ACTION</option>
  <option value="35">LIGHTS OUT!</option>
  <option value="21">BALL BONANZA</option>
  <option value="4">WHINE ON!</option>
  <option value="9">ROLLER COASTER</option>
  <option value="26">BURY MY BODY</option>
  <option value="22">PIANO PANIC</option>
  <option value="39">BATHTUB BURNOFF</option>
  <option value="52">BANKED OVAL</option>
  <option value="1">TREEHOUSE TILES</option>
  <option value="47">VICE SQUAD</option>
  <option value="23">MUSICAL HITS</option>
  <option value="33">TOASTER TROUBLE</option>
  <option value="18">BALL CHASE</option>
  <option value="29">CROSSING CHAOS</option>
  <option value="12">UPS N DOWNS</option>
  <option value="46">BRICKS N TREES</option>
  <option value="7">WINDY WILLOWS</option>
  <option value="11">ATV ACTION</option>
</select>
<select id="speed">
<option value="40">Easy</option>
<option value="30">Medium</option>
<option value="20">Hard</option>
</select>
<a href="https://github.com/gabonator/Projects/tree/master/cicodis32/gamelib/full/mm232">
<svg style="position:relative; top:5px; padding-left:5px;" xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24" width="24" height="24"><path d="M12.5.75C6.146.75 1 5.896 1 12.25c0 5.089 3.292 9.387 7.863 10.91.575.101.79-.244.79-.546 0-.273-.014-1.178-.014-2.142-2.889.532-3.636-.704-3.866-1.35-.13-.331-.69-1.352-1.18-1.625-.402-.216-.977-.748-.014-.762.906-.014 1.553.834 1.769 1.179 1.035 1.74 2.688 1.25 3.349.948.1-.747.402-1.25.733-1.538-2.559-.287-5.232-1.279-5.232-5.678 0-1.25.445-2.285 1.178-3.09-.115-.288-.517-1.467.115-3.048 0 0 .963-.302 3.163 1.179.92-.259 1.897-.388 2.875-.388.977 0 1.955.13 2.875.388 2.2-1.495 3.162-1.179 3.162-1.179.633 1.581.23 2.76.115 3.048.733.805 1.179 1.825 1.179 3.09 0 4.413-2.688 5.39-5.247 5.678.417.36.776 1.05.776 2.128 0 1.538-.014 2.774-.014 3.162 0 .302.216.662.79.547C20.709 21.637 24 17.324 24 12.25 24 5.896 18.854.75 12.5.75Z" fill="silver"></path></svg>
</a></div>
</div>
<br>

<canvas id="canvas" style="position:relative; left:120px; width:80%; max-width:100vw; aspect-ratio: 640/480;"></canvas><br>
<script src="cpu.js"></script>
<script src="controls.js"></script>
<script src="mm2.js"></script>
<script src="fflate.js"></script>
<script src="dos.js"></script>
<script src="vga.js"></script>

<script>
// config
var config = {skipIntro1: false, skipIntro2: false, skipMenuItem:-1, skipMenuChangeControls: false,
skipMenuGameMode: false, skipMenuChangePlayer: false, skipLevelBanner: false, skipLevelGetReady: false,
jumpToLevel: -1, speed:40};

for (var att of window.location.search.substr(1).split("&"))
{
  let [key, value] = att.split("=");
  if (key in config)
  {
    if (value == "true")
      value = true;
    else if (value == "false")
      value = false;
    else
      value = parseInt(value)
    config[key] = value;
  }
}

document.querySelector("#level").value = config.jumpToLevel;
document.querySelector("#level").addEventListener("change", e => {
  config.jumpToLevel = e.target.value;
  config.skipIntro1 = config.skipIntro2 = config.skipMenuChangeControls = config.skipMenuGameMode = config.skipMenuChangePlayer = config.skipLevelGetReady = true;
  config.skipMenuItem = 0;
  document.location.href = "?" + Object.keys(config).map(k => `${k}=${config[k]}`).join("&");
});
document.querySelector("#speed").value = config.speed;
document.querySelector("#speed").addEventListener("change", e => {
  config.speed = e.target.value;
  document.location.href = "?" + Object.keys(config).map(k => `${k}=${config[k]}`).join("&");
});

for (const [key, value] of Object.entries(config))
  globalThis[`mm2_${key}`] = value;

// main

let loadAddress;
let archive = {};

Promise.resolve()
  .then(() => fetch("mm2js.zip"))
  .then(x => x.arrayBuffer())
  .then(x => archive = fflate.unzipSync(new Uint8Array(x)))
  .then(() => {
    init();
    let seq = start();
    let timer = setInterval(()=>
    {
      tick();
      try {
        seq.next();
      } catch (e)
      {
        console.error("crash", e);
        clearInterval(timer);
      }
      display();
    }, config.speed);
  })

function tick()
{
  memoryASet32(ds, 0x2eebd0, memoryAGet32(ds, 0x2eebd0)+4);
    
  for (let i=0; i<10; i++)
    sub_1a88e4();
}

</script>
</body>
</html>
