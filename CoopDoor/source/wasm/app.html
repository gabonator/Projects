<!-- https://gist.github.com/Grezzo/3babdcfffe837a89c31a -->
<style type="text/css">
div.simulator {
  width: 350px;
  text-align: center;
}
div.display {
  height: 78px;
  background: black;
}
div.digit {
  margin-top: 4px;
  margin-bottom: 4px;
  margin-left: 2px;
  margin-right: 2px;
	display: inline-block;
	height: 70px;
	width: 52px;
	position: relative;
  transform: skew(170deg);
}
div.segA {
	width: 16px;
	border-top: 10px solid #333;
	border-right: 10px solid transparent;
	border-left: 10px solid transparent;
	position: absolute;
	left: 2px;
}
div.segB {
	height: 16px;
	border-top: 10px solid transparent;
	border-right: 10px solid #333;
	border-bottom: 5px solid transparent;
	position: absolute;
	top: 2px;
	left: 30px
}
div.segC {
	height: 16px;
	border-top: 5px solid transparent;
	border-right: 10px solid #333;
	border-bottom: 10px solid transparent;
	position: absolute;
	top: 37px;
	left: 30px
}
div.segD {
	width: 16px;
	border-bottom: 10px solid #333;
	border-right: 10px solid transparent;
	border-left: 10px solid transparent;
	position: absolute;
	left: 2px;
	bottom: 0px;
}
div.segE {
	height: 16px;
	border-top: 5px solid transparent;
	border-left: 10px solid #333;
	border-bottom: 10px solid transparent;
	position: absolute;
	top: 37px;
}
div.segF {
	height: 16px;
	border-top: 10px solid transparent;
	border-left: 10px solid #333;
	border-bottom: 5px solid transparent;
	position: absolute;
	top: 2px;
}
div.segGTop {
	width: 16px;
	border-bottom: 5px solid #333;
	border-right: 10px solid transparent;
	border-left: 10px solid transparent;
	position: absolute;
	left: 2px;
	top: 30px;
}
div.segGBottom {
	width: 16px;
	border-top: 5px solid #333;
	border-right: 10px solid transparent;
	border-left: 10px solid transparent;
	position: absolute;
	top: 35px;
	left: 2px;
}
div.segH {
	position: absolute;
	top: 60px;
	left: 42px;
	border-radius: 5px; /*Makes it a circle*/
	width: 10px;
	height: 10px;
  background: #333;
}
</style>

<script type="text/javascript">
dark = "#333";
light = "red";
//Set right border/backround section of right div to illuminate display
function setSegmentState(segment, lit) {
  colour = lit ? light : dark;
  if (segment.substr(0, 2) == "d9")
    colour = lit ? "#bbb" : "#222";

  piece = segment.substr(3, 1);
  switch(piece) {
    case "0":
      document.getElementById(segment).style.borderTopColor = colour;
      break;
    case "1":
    case "2":
      document.getElementById(segment).style.borderRightColor = colour;
      break;
    case "3":
      document.getElementById(segment).style.borderBottomColor = colour;
      break;
    case "4":
    case "5":
      document.getElementById(segment).style.borderLeftColor = colour;
      break;
    case "6":
      //This segment (the central "G" one) is made of two div's borders
      document.getElementById(segment + "Bottom").style.borderTopColor = colour;
      document.getElementById(segment + "Top").style.borderBottomColor = colour;
      break;
    case "7":
      document.getElementById(segment).style.background = colour;
      break;
  }
}
</script>
</head>
<body>
<input type=button value="short click" onClick="setShortClick()">
<input type=button value="long click" onClick="setLongClick()">
<input type=button value="<" onClick="setMove(-1)">
<input type=button value=">" onClick="setMove(1)">

<br><br>
<div>
<div style="width:80px; height:80px; padding-right:8px; float:left; text-align:right">
Auto<br>
<br>
<br>
Manual
</div>
<div class="simulator" style="float:left;">
  <div class="display">
    <div class="digit">
      <div class="segA" ID="d9s0"></div>
      <div class="segD" ID="d9s3"></div>
    </div><div class="digit">
      <div class="segA" ID="d0s0"></div>
      <div class="segB" ID="d0s1"></div>
      <div class="segC" ID="d0s2"></div>
      <div class="segD" ID="d0s3"></div>
      <div class="segE" ID="d0s4"></div>
      <div class="segF" ID="d0s5"></div>
      <div class="segGTop" ID="d0s6Top"></div>
      <div class="segGBottom" ID="d0s6Bottom"></div>
    </div><div class="digit">
      <div class="segA" ID="d1s0"></div>
      <div class="segB" ID="d1s1"></div>
      <div class="segC" ID="d1s2"></div>
      <div class="segD" ID="d1s3"></div>
      <div class="segE" ID="d1s4"></div>
      <div class="segF" ID="d1s5"></div>
      <div class="segGTop" ID="d1s6Top"></div>
      <div class="segGBottom" ID="d1s6Bottom"></div>
    </div><div class="digit">
      <div class="segA" ID="d2s0"></div>
      <div class="segB" ID="d2s1"></div>
      <div class="segC" ID="d2s2"></div>
      <div class="segD" ID="d2s3"></div>
      <div class="segE" ID="d2s4"></div>
      <div class="segF" ID="d2s5"></div>
      <div class="segGTop" ID="d2s6Top"></div>
      <div class="segGBottom" ID="d2s6Bottom"></div>
      <div class="segH" ID="d2s7"></div>
    </div><div class="digit">
      <div class="segA" ID="d3s0"></div>
      <div class="segB" ID="d3s1"></div>
      <div class="segC" ID="d3s2"></div>
      <div class="segD" ID="d3s3"></div>
      <div class="segE" ID="d3s4"></div>
      <div class="segF" ID="d3s5"></div>
      <div class="segGTop" ID="d3s6Top"></div>
      <div class="segGBottom" ID="d3s6Bottom"></div>
      <div class="segH" ID="d3s7"></div>
    </div><div class="digit">
      <div class="segA" ID="d4s0"></div>
      <div class="segB" ID="d4s1"></div>
      <div class="segC" ID="d4s2"></div>
      <div class="segD" ID="d4s3"></div>
      <div class="segE" ID="d4s4"></div>
      <div class="segF" ID="d4s5"></div>
      <div class="segGTop" ID="d4s6Top"></div>
      <div class="segGBottom" ID="d4s6Bottom"></div>
      <div class="segH" ID="d4s7"></div>
    </div>
  </div>
</div>

</div>
<br style="clear:left;">

<div id="display" style="font-size:80px; font-family: monospace; white-space: pre;"></div><br>
<div id="time" style="font-size:14px;"></div><br>
<div id="status" style="font-size:14px;"></div><br>
<input type=checkbox id="rtc_ok" checked>RTC 
<input type=button value="+1 hr" onClick="addOffset(60*60)">
<input type=button value="+1 min" onClick="addOffset(60)">
<input type=button value="-1 min" onClick="addOffset(-60)">
<input type=button value="-1 hr" onClick="addOffset(-60*60)">
<input type=button value="set" onClick="setCustom()">

<script src="app_inline.js"></script>
<script>

function ShowDisplay(buf)
{
  let tabl = [0b0010000, 0b0100000, 0b1000000, 0b0001000, 0b0000100, 0b0000001, 0b0000010, 0b10000000];
  for (var i=0; i<5; i++)
    for (var j=0; j<((i>1)?8:7); j++)
      setSegmentState("d" + i + "s" + j, buf[i] & tabl[j]);
}

var offset = 0;
var click = false, longclick = false, move = 0;
var inhibit = null;
function addOffset(o) { offset += o*1000; inhibit = null; }
function setShortClick() { click = true; inhibit = null; }
function setLongClick() { longclick = true; inhibit = null; }
function setMove(d) { move += d; inhibit = null; }
function setCustom(o) { 

  var d = new Date(new Date().getTime() + offset);
  var user = prompt("Set new date", d);
  if (user)
    offset = new Date(user).getTime() - new Date().getTime();
}

//window.miniApp = new MiniApp()

Module['noRun'] = true;	

window.onload = () => {
  Module['imports'] = {
    apiDebug: (ptr) => { 
      var msg = Module['imports'].log(ptr);
      if (msg == "Actuator open")
      {
        document.querySelector("#status").innerHTML = "opened";
        document.querySelector("#status").style = "font-size:20px; background: #00bb00; width:120px; color:white;";
      }
      if (msg == "Actuator close")
      {
        document.querySelector("#status").innerHTML = "closed";
        document.querySelector("#status").style = "font-size:20px; background: #bb0000; width:120px; color:white;";
      }
      console.log("apiDebug: '" + msg + "'") ;
    },
    apiShow: (ptr) => {
      console.log("apiShow: " + Module['imports'].log(ptr));
//      showDisplay(Module['imports'].log(ptr));
      document.querySelector("#display").innerHTML = Module['imports'].log(ptr);
    },
    apiShowSegments: (ptr) => {
      var buf = [];
      for (var i=0; i<5; i++)
        buf.push(Module['memory'][ptr+i]);
      ShowDisplay(buf);
    },
    apiGetDateTime: (ptr) => { 
      var d = new Date(new Date().getTime() + offset);

      var buf = [d.getUTCHours(), d.getUTCMinutes(), d.getSeconds(),
        d.getUTCDate(), d.getUTCMonth()+1, 0,
        d.getUTCFullYear()&255, d.getUTCFullYear()>>8];

      document.querySelector("#time").innerHTML = d;

      for (var i=0; i<buf.length; i++)
        Module['memory'][ptr+i] = buf[i];
      return document.querySelector("#rtc_ok").checked; 
    },
    apiCursor: (a, b) => { 
      setSegmentState("d9s0", a);
      setSegmentState("d9s3", b);
    },
    apiSleep: (ms) =>
    {
      inhibit = new Date().getTime() + ms;
    },
    apiShortClick: () => { 
      if (!click)
        return false;
      click = false;
      return true;
    },
    apiLongClick: () => { 
      if (!longclick)
        return false;
      longclick = false;
      return true;
    },
    apiOnMove: () => {
      var old = move;
      move = 0;
      return old;
    },
    apiStorageSave: (buffer, len) => {
      var b = [];
      for (var i=0; i<len; i++)
        b.push(Module['memory'][buffer+i]);
      console.log("Save buffer");
      console.log(b);
      return true;
    },
    apiStorageLoad: (buffer, len) => {
      var b = [106, 17, 1, 2, 1, 225, 0, 171, 0, 0, 0, 0, 11];
      if (len != b.length)
        throw "Wrong length";
      for (var i=0; i<b.length; i++)
        Module['memory'][buffer+i] = b[i];
      return true;
    },
    apiChangeTime: (h, m, d, mon, y) => {
      offset += (((mon*31 + y*365 + d)*24 + h)*60 + m)*60 *1000;
    },
    log: (ptr) => {
      var text = "";
      for (var i=0; i<50 && Module['memory'][ptr+i] != 0; i++)
        text += String.fromCharCode(Module['memory'][ptr+i]);
      return text;
//      console.log(text); 
    }
  };

  Module['exports'] = {
    appFinish: null,
    appInit: null,
    appLoop: null
  };

  if (Module['run']) 
    Module['run']()
};

Module['onRuntimeInitialized'] = () =>
{
  Module.appInit();
  setInterval(() =>
  {
    if (inhibit && inhibit > new Date().getTime())
      return;
    Module.appLoop();
  }, 100);
}
</script>
<script src="app_app.js"></script>
</body>
