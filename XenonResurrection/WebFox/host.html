<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>
/*
html, body {
  overflow:hidden;
}
*/
body {
background: #000000;
}
</style>
</head>
<body>
<canvas id="canvas" style="width:960px; height:600px;"></canvas><br>

<script>
</script>

<script src="fox.js"></script>
<script src="fox.resources.js"></script>
<script src="ega.js"></script>
<script src="vga.js"></script>
<script src="cpu.js"></script>

<script>
var _datab = new ArrayBuffer(0x10000*20);
var memory = new Uint8Array(_datab, 0, 0x10000*20);
var memorys = new Int8Array(_datab, 0, 0x10000*20);

var r0 = new ArrayBuffer(16);
var r16 = new Uint16Array(r0, 0, 8);
var r16s = new Int16Array(r0, 0, 8);
var r8 = new Uint8Array(r0, 0, 16);
var r8s = new Int8Array(r0, 0, 16);


flags = {carry:0, direction:0, zero:0};

  var data = Module['game.exe'];
  for (var i=0; i<data.length; i++)
    memory[0x168f0 - 0x6af0+i] = data[i];

    ds = 0x168f;
    cs = 0x1020;
    ss = 0x200; //0x169f;
    assert(memory[ds*16 + 0x0] == 'F'.charCodeAt(0));
    assert(memory[cs*16 + 0x0] == 3);
    ds = 0x01dd-0x087c+0x168f;
    ss = 0x01ed-0x087c+0x168f;
    bp = 0x091c;
    es = ds;
    sp = 64;
    memory[ds*16 + 0x0080] = 0;
    memory[ds*16 + 0x0081] = 0x0d;



var can = document.getElementById("canvas");
var ctx = can.getContext('2d');
can.width = 320;
can.height = 200;
var data = ctx.createImageData(can.width, can.height);

function display()
{
  var p = 0;
  var pixels = data.data;
  for (var y=0; y<200; y++)
    for (var x=0; x<320; x++)
    {
      var c = video.getPixel(x, y);
      pixels[p++] = c>>16;
      pixels[p++] = (c>>8)&0xff;
      pixels[p++] = c & 0xff;
      pixels[p++] = 255;
    }
  ctx.putImageData(data, 0, 0);
}
var _iter = 0;
function* _sync(k)
{
  yield 0;
}

var sequence = entry();
if(1)
{
  setInterval( () =>
  {
    sequence.next();
    display();
  }, 50);
} else{
  sequence.next();
//  sequence.next();
//  sequence.next();
//  sequence.next();
//  sequence.next();
  display();
}

function assert(x)
{
  if (!x) 
    throw new Error("assertion failed");
}
    document.onkeydown = function(evt) {
        evt = evt || window.event;
        var p = 1;
        switch (evt.keyCode)
        {
          case 38: memory[0x168f * 16 + 0x488] = p; break;  // up
          case 40: memory[0x168f * 16 + 0x490] = p; break;  // down
          case 37: memory[0x168f * 16 + 0x48b] = p; break; // left
          case 39: memory[0x168f * 16 + 0x48b] = p; break; // right
          case 32: memory[0x168f * 16 + 0x45c] = p; break;        
        }
    }
    document.onkeyup = function(evt) {
        evt = evt || window.event;
        var p = 0;
        switch (evt.keyCode)
        {
          case 38: memory[0x168f * 16 + 0x488] = p; break;  // up
          case 40: memory[0x168f * 16 + 0x490] = p; break;  // down
          case 37: memory[0x168f * 16 + 0x48b] = p; break; // left
          case 39: memory[0x168f * 16 + 0x48b] = p; break; // right
          case 32: memory[0x168f * 16 + 0x45c] = p; break;        
        }
    }

</script>
</body>
</html>