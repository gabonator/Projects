<html>
<head>
<meta name="viewport" content="width=device-width, user-scalable=no">
<style>
/*
html, body {
  overflow:hidden;
}
*/
body {
background: #000000;
}
</style>
</head>
<body>

<img id="sky0" src="l1_sky.png" style="position:absolute; left:0px; top:0px; width:3312px; height:1776px;">
<img id="sky1" src="l1_sky.png" style="position:absolute; left:3312px; top:0px; width:3312px; height:1776px;">
<img id="moon" src="moon.png" style="position:absolute; left:700px; top:40px; width:100px; height:100px; mix-blend-mode: lighten; opacity:0.8">

<img id="back0" src="l1_back.png" style="position:absolute; left:0px; top:0px; width:3303px; height:1776px; opacity:1">
<img id="back1" src="l1_back.png" style="position:absolute; left:3303px; top:0px; width:3303px; height:1776px;opacity:1">
<img id="map" src="l1_map.png" style="position:absolute; left:0px; top:0px; width:12288px; height:1776px">

<canvas id="canvas" style="border:solid 1px #808080; position:absolute; left:0px; top:0px; width:1200px; height:600px;"></canvas><br>

<img id="glow0" src="glow.gif" style="position:absolute; left:402px; top:460px; width:330px; height:270px; opacity:0.3; mix-blend-mode: lighten;">
<img id="glow1" src="glow.gif" style="position:absolute; left:1872px; top:460px; width:330px; height:270px; opacity:0.3; mix-blend-mode: lighten;">
<img id="glow2" src="glow.gif" style="position:absolute; left:2628px; top:460px; width:330px; height:270px; opacity:0.3; mix-blend-mode: lighten;">
<img id="glow3" src="glow.gif" style="position:absolute; left:3568px; top:460px; width:330px; height:270px; opacity:0.3; mix-blend-mode: lighten;">
<img id="steam0" src="steam.gif" style="position:absolute; left:22px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam1" src="steam.gif" style="position:absolute; left:402px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam2" src="steam.gif" style="position:absolute; left:912px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam3" src="steam.gif" style="position:absolute; left:1362px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam4" src="steam.gif" style="position:absolute; left:1772px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam5" src="steam.gif" style="position:absolute; left:2372px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam6" src="steam.gif" style="position:absolute; left:2852px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam7" src="steam.gif" style="position:absolute; left:3282px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">
<img id="steam8" src="steam.gif" style="position:absolute; left:3762px; top:500px; width:330px; height:270px; opacity:0.9; mix-blend-mode: lighten;">


<script>
</script>

<script src="fox.js"></script>
<script src="indirect.js"></script>
<script src="fox.resources.js"></script>
<script src="ega.js"></script>
<script src="vga.js"></script>
<script src="cpu.js"></script>

<script>
var collect = [];
var _datab = new ArrayBuffer(0x10000*20);
var memory = new Uint8Array(_datab, 0, 0x10000*20);
var memorys = new Int8Array(_datab, 0, 0x10000*20);

var r0 = new ArrayBuffer(16);
var r16 = new Uint16Array(r0, 0, 8);
var r16s = new Int16Array(r0, 0, 8);
var r8 = new Uint8Array(r0, 0, 16);
var r8s = new Int8Array(r0, 0, 16);


flags = {carry:0, direction:0, zero:0};

  var data = Module['game.exe'];
  for (var i=0; i<data.length; i++)
    memory[0x168f0 - 0x6af0+i] = data[i];

    ds = 0x168f;
    cs = 0x1020;
    ss = 0x200; //0x169f;
    assert(memory[ds*16 + 0x0] == 'F'.charCodeAt(0));
    assert(memory[cs*16 + 0x0] == 3);
    ds = 0x01dd-0x087c+0x168f;
    ss = 0x01ed-0x087c+0x168f;
    bp = 0x091c;
    es = ds;
    sp = 64;
    memory[ds*16 + 0x0080] = 0;
    memory[ds*16 + 0x0081] = 0x0d;



var can = document.getElementById("canvas");
var ctx = can.getContext('2d');
can.width = 400;
can.height = 200;
var data = ctx.createImageData(can.width, can.height);

var overlay = [
{id:"glow0", left:402, top:460},
{id:"glow1", left:1872, top:460},
{id:"glow2", left:2628, top:460},
{id:"glow3", left:3568, top:460},
{id:"steam0", left:22, top:500},
{id:"steam1", left:402, top:500},
{id:"steam2", left:912, top:500},
{id:"steam3", left:1362, top:500},
{id:"steam4", left:1772, top:500},
{id:"steam5", left:2372, top:500},
{id:"steam6", left:2852, top:500},
{id:"steam7", left:3282, top:500},
{id:"steam8", left:3762, top:500}
];


var oldScrollX = 25*3*16;
var oldScrollY = 0*3*16;
function display()
{
  var p = 0;
//  ctx.clearRect(0, 0, canvas.width, canvas.height);
  var pixels = data.data;
  for (var y=0; y<200; y++)
    for (var x=0; x<400; x++)
    {
      pixels[p++] = 0;
      pixels[p++] = 0;
      pixels[p++] = 0;
      pixels[p++] = 0;
    }

/*
  for (var y=0; y<200; y++)
    for (var x=0; x<320; x++)
    {
      var c = video.getPixel(x, y);
      pixels[p++] = c>>16;
      pixels[p++] = (c>>8)&0xff;
      pixels[p++] = c & 0xff;
      pixels[p++] = 255;
    }
*/

  var map = document.getElementById("map");
  var newScrollX = memory16get(0x168f*16 + 0x5270)*3*16;
  var newScrollY = memory16get(0x168f*16 + 0x5272)*3*16;

  var scrollX = Math.floor(oldScrollX*0.9+newScrollX*0.1);
  var scrollY = Math.floor(oldScrollY*0.9+newScrollY*0.1);
  oldScrollX = scrollX;
  oldScrollY = scrollY;

//  var scrollX = newScrollX;
//  var scrollY = newScrollY;

  var correctionX = newScrollX - scrollX;
  var correctionY = newScrollY - scrollY;
  map.style.left = -scrollX;
  map.style.top = -scrollY;

  for (var i=0; i<overlay.length; i++)
  {
    var o = document.getElementById(overlay[i].id);
    o.style.left = overlay[i].left*3-scrollX;
    o.style.top = overlay[i].top*3-scrollY;
  }
  var back0 = document.getElementById("back0");
  back0.style.left = -scrollX*0.3;
  back0.style.top = -(scrollY-25*3*16)*1.1 - 25*3*16;
  var back1 = document.getElementById("back1");
  back1.style.left = -scrollX*0.3+3303;
  back1.style.top = -(scrollY-25*3*16)*1.1 - 25*3*16;

  var sky0 = document.getElementById("sky0");
  sky0.style.left = -scrollX*0.1;
  sky0.style.top = 0;
  var sky1 = document.getElementById("sky1");
  sky1.style.left = -scrollX*0.1+3312;
  sky1.style.top = 0;

  var pixel = (x, y, c) =>
  {
    if (x<0 || x>=400 || y<0 || y>=200)
      return;
    data.data[(x+y*400)*4] = (c>>16) & 0xff;
    data.data[(x+y*400)*4+1] = (c>>8) & 0xff;
    data.data[(x+y*400)*4+2] = c & 0xff;
    data.data[(x+y*400)*4+3] = 0xff;
  } 

  can.style.left = correctionX;
  can.style.top = correctionY;
    for(var i=0; i<collect.length; i++)
    {
        var frame = collect[i].w*collect[i].h;
        var pitch = collect[i].w;
        for (var y=0; y<collect[i].h; y++)
        {
            for (var x=0; x<collect[i].w*8; x++)
            {
                var plane0 = memory[collect[i].s*16+ collect[i].o+y*pitch+Math.floor(x/8)+frame*0];
                var plane1 = memory[collect[i].s*16+ collect[i].o+y*pitch+Math.floor(x/8)+frame*1];
                var plane2 = memory[collect[i].s*16+ collect[i].o+y*pitch+Math.floor(x/8)+frame*2];
                var plane3 = memory[collect[i].s*16+ collect[i].o+y*pitch+Math.floor(x/8)+frame*3];
                var plane4 = memory[collect[i].s*16+ collect[i].o+y*pitch+Math.floor(x/8)+frame*4];
                var p0 = (plane0 >> (7-(x&7)))&1;
                var p1 = (plane1 >> (7-(x&7)))&1;
                var p2 = (plane2 >> (7-(x&7)))&1;
                var p3 = (plane3 >> (7-(x&7)))&1;
                var p4 = (plane4 >> (7-(x&7)))&1;
                var p = p1 + 2*p2 + 4*p3 + 8*p4;
                p = ega.palette[p];
                if (p0)
                {
                    if (!collect[i].t)
                        pixel(signed16(collect[i].x)+ x, signed16(collect[i].y) + y, p);
                    else
                        pixel(signed16(collect[i].x) + collect[i].w*8-1 - x, signed16(collect[i].y) + y, p);
                }

            }
        }
    }
  ctx.putImageData(data, 0, 0);

}
var _iter = 0;
function* _sync(k)
{
  yield 0;
}

var sequence = entry();
if(1)
{
  setInterval( () =>
  {
    sequence.next();
    display();
  }, 25);
} else{
  sequence.next();
//  sequence.next();
//  sequence.next();
//  sequence.next();
//  sequence.next();
  display();
}

function assert(x)
{
  if (!x) 
    throw new Error("assertion failed");
}
    document.onkeydown = function(evt) {
        evt = evt || window.event;
        var p = 1;
        switch (evt.keyCode)
        {
          case 38: memory[0x168f * 16 + 0x488] = p; break;  // up
          case 40: memory[0x168f * 16 + 0x490] = p; break;  // down
          case 37: memory[0x168f * 16 + 0x48b] = p; break; // left
          case 39: memory[0x168f * 16 + 0x48d] = p; break; // right
          case 32: memory[0x168f * 16 + 0x45c] = p; break;        
        }
evt.preventDefault();
    }
    document.onkeyup = function(evt) {
        evt = evt || window.event;
        var p = 0;
        switch (evt.keyCode)
        {
          case 38: memory[0x168f * 16 + 0x488] = p; break;  // up
          case 40: memory[0x168f * 16 + 0x490] = p; break;  // down
          case 37: memory[0x168f * 16 + 0x48b] = p; break; // left
          case 39: memory[0x168f * 16 + 0x48d] = p; break; // right
          case 32: memory[0x168f * 16 + 0x45c] = p; break;        
        }
evt.preventDefault();
    }

</script>
</body>
</html>