<canvas id="canvas" width="320" height="200" style="border: 1px solid #d0d0d0; transform:translate(320px, 175px) scale(2);"></canvas>

<script src="app_inline.js"></script>
<script>
    ABORT = false;
     function _apiPrint(ptr)
    { 
      console.log(UTF8ToString(ptr));
    }
//  int apiRead(char* name, int readofs, int readlen, void* targetofs);

    function _apiRead(ptrName, readOfs, readLen, ptrData) 
    {
      var name = UTF8ToString(ptrName);
      console.log("Read ", name);
      var b = Module[name];
      var willRead = Math.min(b.length-readOfs, readLen);
      var memory = HEAP8; //Module['memory'];
      for (var i=0; i<readLen; i++)
        memory[i+ptrData] = b[i+readOfs];
      return willRead;
    }

  Module['wasm'] = Module['wasmBinary'];

</script>
<script src="app.js"></script>
<script src="resources.js"></script>
<!--<script src="fibers.js"></script>-->
<script>
/*
var Module = typeof Module !== 'undefined' ? Module : {};

function Main() 
{
  var WASM_PAGE_SIZE = 65536;
  var TOTAL_MEMORY = 65536;
  var DYNAMICTOP_PTR = 11856;

  var abort = (what) => { throw 'abort(' + what + '). Build with -s ASSERTIONS=1 for more info.'};

  var env =
     { "abort": abort, 
       "_abort": abort,
       "__assert_fail": abort, 
       "__setErrNo": abort, 
       "emscripten_get_heap_size": abort, 
       "emscripten_memcpy_big": abort, 
       "emscripten_resize_heap": abort,
       "abortOnCannotGrowMemory": abort, 
       "DYNAMICTOP_PTR": DYNAMICTOP_PTR,
       memory:new WebAssembly.Memory({ 'initial': TOTAL_MEMORY / WASM_PAGE_SIZE, 'maximum': TOTAL_MEMORY / WASM_PAGE_SIZE }),
       table:new WebAssembly.Table({'initial': 84,'maximum': 84,'element': 'anyfunc'}),
       '__memory_base': 1024, 
       '__table_base': 0
  };

  var imports = Module["imports"];
  for (var i in imports)
    env[i] = imports[i];

  return WebAssembly.instantiate(new Uint8Array(Module['wasmBinary']), {env:env})
  .then( output => 
   {
    var exports = output.instance.exports;
    Module['asm'] = exports;
    if (Module["asm"]["__wasm_call_ctors"]) Module["asm"]["__wasm_call_ctors"]();
//    Module["memory"] = new Uint8Array(env.memory.buffer);

    var _exports = Module['exports'];
    for (var i in _exports)
      Module[i] = _exports[i] = Module["asm"][i];

    Module["memory"] = new Uint8Array(exports.memory.buffer);        
    return output;
  });
};

  Module['imports'] = {
    apiPrint: (ptr) => { 
      var msg = Module['imports'].string(ptr);
      console.log(msg);
    },
    string: (ptr) => {
      var text = "";
      for (var i=0; i<50 && Module['memory'][ptr+i] != 0; i++)
        text += String.fromCharCode(Module['memory'][ptr+i]);
      return text;
    },
    apiRead: (ptrName, ptrData) => {
//      console.log(Module['imports'].string(ptrName), ptrData)
      var name = Module['imports'].string(ptrName);
      var b = Module[name];
      var memory = Module['memory'];
      for (var i=0; i<b.length; i++)
        memory[i+ptrData] = b[i];
    },
    emscripten_fiber_swap: _emscripten_fiber_swap,
    emscripten_fiber_init_from_current_context: _emscripten_fiber_init_from_current_context,
    emscripten_fiber_init: _emscripten_fiber_init,
  }
  Module['exports'] = {
    appFinish: null,
    appInit: null,
    appLoop: null
  };
Module['run'] = Main;

Main().then( (m)=>
{
  console.log("pre call");
  Module.appInit();
  console.log("post call");

  console.log("pre call2");
  Module.appInit();
  console.log("post call2");
//  console.log(m.instance.exports.appInit());
});
*/
setTimeout(ready, 100);
var phase = 0;
var memoryOfs = 0;

    var canvas = document.getElementById('canvas');
    var ctx = canvas.getContext('2d');
    var imageData = this.ctx.getImageData(0, 0, canvas.width, canvas.height);


function __onSleep()
{
  var ptr = _appVideo();
    const data = new Uint8ClampedArray(Module.asm.memory.buffer, ptr, 320 * 200 * 4);
    const img = new ImageData(data, 320, 200);
    this.ctx.putImageData(img, 0, 0);

//  console.log("video", ptr);
}
setInterval(()=>{
//  var ptr = _appVideo();
//  console.log("video", ptr);
}, 1000);
function ready() {
  _appInit();
  memoryOfs = _appMemory();
//  _appLoop();
// switch(phase++)
/*
sequence.next();
memory[0x1228 * 16 + 0x4d44 + 0x3d] = 1; // F3 - vga
sequence.next();
memory[0x1228 * 16 + 0x4d44 + 0x3d] = 0;
memory[0x1228 * 16 + 0x4d44 + 0x3f] = 1; // F5 - no sound
sequence.next();
memory[0x1228 * 16 + 0x4d44 + 0x3f] = 0;
*/
}

    document.onkeydown = function(evt) {
        evt = evt || window.event;
        var memory = HEAP8;
        var mo = memoryOfs // Module.asm.memory;
        switch (evt.keyCode)
        {
          case 0x33: memory[mo+0x1228 * 16 + 0x4d44 + 0x3d] = 1; break; 
          case 0x35: memory[mo+0x1228 * 16 + 0x4d44 + 0x3f] = 1; break; 

          case 38: memory[mo+0x1228 * 16 + 0x4d44 + "M".charCodeAt(0)] = 1; break; // right
          case 40: memory[mo+0x1228 * 16 + 0x4d44 + "P".charCodeAt(0)] = 1; break; // down
          case 37: memory[mo+0x1228 * 16 + 0x4d44 + "K".charCodeAt(0)] = 1; break; // left
          case 32: memory[mo+0x1228 * 16 + 0x4d44 + 0x1c] = 1; break; // space -> enter
          case 27: memory[mo+0x1228 * 16 + 0x4d44 + 1] = 1; break; // esc
        }
    }
    document.onkeyup = function(evt) {
        evt = evt || window.event;
        var memory = HEAP8;
        var mo = memoryOfs // Module.asm.memory;
        switch (evt.keyCode)
        {
          case 0x33: memory[mo+0x1228 * 16 + 0x4d44 + 0x3d] = 0; break; 
          case 0x35: memory[mo+0x1228 * 16 + 0x4d44 + 0x3f] = 0; break; 
          case 38: memory[mo+0x1228 * 16 + 0x4d44 + "H".charCodeAt(0)] = 0; break; // up
          case 39: memory[mo+0x1228 * 16 + 0x4d44 + "M".charCodeAt(0)] = 0; break; // right
          case 40: memory[mo+0x1228 * 16 + 0x4d44 + "P".charCodeAt(0)] = 0; break; // down
          case 37: memory[mo+0x1228 * 16 + 0x4d44 + "K".charCodeAt(0)] = 0; break; // left
          case 32: memory[mo+0x1228 * 16 + 0x4d44 + 0x1c] = 0; break; // space -> enter
          case 27: memory[mo+0x1228 * 16 + 0x4d44 + 1] = 0; break; // esc
        }
    }


</script>